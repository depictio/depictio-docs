name: Deploy Docs

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'pyproject.toml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v0.6.0-b5)'
        required: true
      alias:
        description: 'Alias (latest, beta, or none)'
        required: false
        default: 'beta'

jobs:
  deploy-mike:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv sync

      - name: Get version from pyproject.toml
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            ALIAS="${{ github.event.inputs.alias }}"
          else
            VERSION="v$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')"
            # Beta releases get 'beta' alias, stable get 'latest'
            if [[ "$VERSION" == *"-b"* ]]; then
              ALIAS="beta"
            else
              ALIAS="latest"
            fi
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "alias=${ALIAS}" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Deploy with mike
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ALIAS="${{ steps.version.outputs.alias }}"

          if [ "$ALIAS" != "none" ] && [ -n "$ALIAS" ]; then
            uv run mike deploy --push --update-aliases "$VERSION" "$ALIAS"
          else
            uv run mike deploy --push "$VERSION"
          fi

      - name: Summary
        run: |
          echo "## Documentation Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Alias**: ${{ steps.version.outputs.alias }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://depictio.github.io/depictio-docs/${{ steps.version.outputs.version }}/" >> $GITHUB_STEP_SUMMARY
